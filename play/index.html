<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LEGO 픽셀 설계도 · 방문자</title>
<style>
  :root{ --bg:#f6f2dd; --card:#ffe2ea; --ink:#222; --border:#222; --grid:#d6cfae; --grid10:#9c9576; }
  *{box-sizing:border-box}
  body{margin:0;font-family:ui-sans-serif,system-ui,'Malgun Gothic',AppleSDGothicNeo,sans-serif;color:var(--ink);background:#fafafa}
  .topbar{display:flex;gap:12px;align-items:center;padding:12px 14px;border-bottom:3px solid var(--border);background:#fff;flex-wrap:wrap}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border:3px solid var(--border);border-radius:10px;background:#eafcf4;font-weight:800;cursor:pointer;box-shadow:2px 2px 0 var(--border);min-height:44px}
  .btn.secondary{background:#fff}
  .btn:active{transform:translate(1px,1px);box-shadow:1px 1px 0 var(--border)}
  .icon{width:18px;height:18px;background-size:18px 18px;background-repeat:no-repeat;display:inline-block}
  .i-save{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"><rect width="18" height="18" rx="2" fill="%2300b37a"/><path d="M4 4h7v5H4zM4 12h10v2H4z" fill="white"/></svg>')}
  .i-clear{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="18" height="18"><rect width="18" height="18" rx="2" fill="%23ffef9c"/><path d="M4 6h10M6 6v8m6-8v8" stroke="%23222" stroke-width="2"/></svg>')}

  .app{display:grid;grid-template-columns:280px 1fr;gap:16px;padding:16px;max-width:1200px;margin:0 auto}
  .sidebar{padding:12px}
  .workspace{background:var(--bg);border:3px solid var(--border);border-radius:6px;padding:12px}
  .boardFrame{border:8px solid #fff;border-radius:4px;background:#fff;box-shadow:inset 0 0 0 2px #ddd;width:fit-content;margin:auto;max-width:100%}
  canvas{border:1px solid #000;image-rendering:pixelated;display:block;width:100%;height:auto;touch-action:none}

  .card{border:3px solid var(--border);border-radius:10px;background:var(--card);padding:10px;box-shadow:2px 2px 0 var(--border)}
  .card h4{margin:0 0 8px}
  .swatches{display:grid;grid-template-columns:repeat(4, minmax(24px, 1fr));gap:10px}
  .swatch{width:100%;aspect-ratio:1;border:2px solid #999;border-radius:6px;cursor:pointer}
  .swatch.selected{outline:3px solid var(--border);outline-offset:2px}

  .tools{margin-top:12px;display:grid;grid-template-columns:repeat(2, minmax(120px, 1fr));gap:10px}
  .tool{display:inline-flex;justify-content:center;align-items:center;gap:8px;padding:10px;border:3px solid var(--border);border-radius:10px;background:#fff;font-weight:800;cursor:pointer;box-shadow:2px 2px 0 var(--border);min-height:44px}
  .tool.active{background:#e7fff1}
  .ico{width:22px;height:22px;background-size:22px 22px;background-repeat:no-repeat}
  .t-pen{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M4 14v4h4l10-10-4-4L4 14z" fill="%23222"/></svg>')}
  .t-eraser{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M5 15l6-6a2 2 0 0 1 3 0l3 3a2 2 0 0 1 0 3l-3 3H8l-3-3z" fill="%23222"/></svg>')}
  .t-move{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M11 2l3 3h-2v4h4V7l3 3-3 3v-2h-4v4h2l-3 3-3-3h2v-4H6v2l-3-3 3-3v2h4V5H8l3-3z" fill="%23222"/></svg>')}
  .t-text{background-image:url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M4 5h14v2h-6v10h-2V7H4z" fill="%23222"/></svg>')}

  .smallbtn{margin-top:10px;display:inline-flex;align-items:center;justify-content:center;gap:6px;padding:10px;border:3px solid var(--border);border-radius:10px;background:#fff;font-weight:800;cursor:pointer;box-shadow:2px 2px 0 var(--border);min-height:44px;width:100%}

  .modal{position:fixed;inset:0;background:rgba(0,0,0,.25);display:none;align-items:flex-start;justify-content:center;padding-top:60px;z-index:50}
  .panel{width:min(92vw,520px);max-height:80vh;overflow:auto;border:3px solid var(--border);border-radius:12px;background:#fff;box-shadow:8px 8px 0 var(--border);padding:14px}
  .panel h4{margin:0 0 8px}
  .closeX{position:sticky;top:0;float:right;cursor:pointer;font-weight:900;font-size:20px;padding:4px 6px}

  .libPanel{height:360px;overflow:auto;border:3px solid var(--border);border-radius:10px;background:var(--card);padding:10px;box-shadow:2px 2px 0 var(--border)}
  .libGrid{display:grid;grid-template-columns:repeat(6, 64px);gap:10px}
  .tileCard canvas{width:64px;height:64px;border:2px solid #ddd;background:#fafafa;display:block}

  @media (max-width: 820px){ .libGrid{grid-template-columns:repeat(5, 64px)} }
  @media (max-width: 560px){ .libGrid{grid-template-columns:repeat(4, 64px)} }
  @media (max-width: 420px){ .libGrid{grid-template-columns:repeat(3, 64px)} }
  @media (max-width: 900px){
    .app{grid-template-columns:1fr}
    .workspace{order:1}
    .sidebar{order:2}
    .swatches{grid-template-columns:repeat(6, minmax(24px, 1fr))}
  }
  @media (max-width: 480px){
    .swatches{grid-template-columns:repeat(4, minmax(24px, 1fr))}
    .tools{grid-template-columns:1fr 1fr}
  }
</style>
</head>
<body>
<script>const IS_VISITOR = true;</script>

<div class="topbar">
  <button class="btn" id="savePng"><span class="icon i-save"></span>저장하기</button>
  <button class="btn secondary" id="clearBoard"><span class="icon i-clear"></span>모두 지우기</button>
</div>

<div class="app">
  <aside class="sidebar">
    <div class="card" style="margin-bottom:12px;">
      <h4>색상 (연필)</h4>
      <div id="brushSwatches" class="swatches"></div>
    </div>

    <div class="card" style="margin-bottom:12px;">
      <h4>판 색상</h4>
      <div id="boardSwatches" class="swatches"></div>
    </div>

    <div class="tools">
      <button class="tool active" data-tool="paint"><span class="ico t-pen"></span>그리기</button>
      <button class="tool" data-tool="erase"><span class="ico t-eraser"></span>지우개</button>
      <button class="tool" data-tool="select"><span class="ico t-move"></span>이동</button>
      <button class="tool" id="openText"><span class="ico t-text"></span>글자</button>
    </div>

    <!-- 방문자: 업로드/저장 숨김 (JS에서 display:none) -->
    <button class="smallbtn" id="saveUserSet">내 패턴 저장</button>
    <button class="smallbtn" id="openPattern">패턴 추가</button>
  </aside>

  <section class="workspace">
    <div class="boardFrame">
      <canvas id="legoCanvas"></canvas>
    </div>
  </section>
</div>

<!-- 글자 팝업 -->
<div class="modal" id="textModal">
  <div class="panel">
    <div class="closeX" id="closeText">×</div>
    <h4>글자 입력 (2줄 가능)</h4>
    <textarea id="centerText" style="width:100%;height:64px;resize:vertical" inputmode="latin-name" autocomplete="off" autocapitalize="characters">HELLO
WORLD</textarea>
    <div style="display:flex;align-items:center;gap:10px;margin:8px 0 12px;">
      <label>글꼴
        <select id="fontSizeSel">
          <option value="large">크게(5×7)</option>
          <option value="tiny">작게(4×5)</option>
        </select>
      </label>
    </div>
    <div>
      <div style="font-size:12px;font-weight:800;margin-bottom:6px;">글자색</div>
      <div id="textSwatches" class="swatches"></div>
    </div>
    <div style="margin-top:10px"><small>입력/글꼴/색을 바꾸면 즉시 보드에 반영됩니다.</small></div>
  </div>
</div>

<!-- 패턴 팝업 (방문자: 드롭존 없음) -->
<div class="modal" id="patternModal">
  <div class="panel">
    <div class="closeX" id="closePattern">×</div>
    <h4>패턴 선택</h4>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:8px;">
      <div>
        <div style="font-size:12px;font-weight:800;margin-bottom:6px;">패턴 색상 1</div>
        <div id="pat1Swatches" class="swatches"></div>
      </div>
      <div>
        <div style="font-size:12px;font-weight:800;margin-bottom:6px;">패턴 색상 2</div>
        <div id="pat2Swatches" class="swatches"></div>
      </div>
    </div>
    <div class="libPanel"><div id="libGrid" class="libGrid"></div></div>
  </div>
</div>

<script>
/* ===== 공통 설정/상태 ===== */
const size=32, MARGIN=1, innerMin=MARGIN, innerMax=size-MARGIN-1, innerSize=size-MARGIN*2;
const offset=20, cellSize=22;
const PALETTE=['#ffffff','#cc0a00','#0039d1','#febc06','#fff87c','#000000','#6d4b97','#75b8ff'];
const BOARD_COLORS=['#ffffff','#ffe2ea','#fff6a8','#e3f1ff','#f1e7ff'];

let brushColor=PALETTE[1], textColor=PALETTE[1], patternColor1=PALETTE[1], patternColor2=PALETTE[2];
let bgColor = BOARD_COLORS[0];
let grid=Array.from({length:size},()=>Array(size).fill(bgColor));
let textLayer=Array.from({length:size},()=>Array(size).fill(null));

const canvas=document.getElementById('legoCanvas'), ctx=canvas.getContext('2d');
const GRID_WH=offset+size*cellSize+offset; canvas.width=GRID_WH; canvas.height=GRID_WH;

/* 팔레트 생성 */
function makeSwatches(hostId, colors, initial, onPick){
  const host=document.getElementById(hostId);
  colors.forEach(col=>{
    const d=document.createElement('div');
    d.className='swatch'+(col===initial?' selected':''); d.style.background=col; d.title=col;
    d.onclick=()=>{ [...host.querySelectorAll('.swatch')].forEach(s=>s.classList.remove('selected')); d.classList.add('selected'); onPick(col); };
    host.appendChild(d);
  });
}
makeSwatches('brushSwatches', PALETTE, brushColor, c=>brushColor=c);
makeSwatches('textSwatches' , PALETTE, textColor , c=>{ textColor=c; rebuildTextLayer(); });
makeSwatches('pat1Swatches' , PALETTE, patternColor1, c=>{ patternColor1=c; renderLibrary(); });
makeSwatches('pat2Swatches' , PALETTE, patternColor2, c=>{ patternColor2=c; renderLibrary(); });
makeSwatches('boardSwatches', BOARD_COLORS, bgColor, setBoardColor);

/* 판 색 변경 */
function setBoardColor(newColor){
  const prev = bgColor; if(prev===newColor) return;
  for(let y=0;y<size;y++) for(let x=0;x<size;x++){ if(grid[y][x]===prev) grid[y][x]=newColor; }
  bgColor = newColor; drawMain();
}

/* 도구 선택/커서 */
let mode='paint', isPainting=false, isErasing=false;
function selectTool(m){
  mode=m;
  document.querySelectorAll('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===m));
  const CUR_ERASER='data:image/svg+xml;utf8,'+encodeURIComponent(`<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22"><path d="M5 15l6-6a2 2 0 0 1 3 0l3 3a2 2 0 0 1 0 3l-3 3H8l-3-3z" fill="black"/></svg>`);
  if(m==='paint') canvas.style.cursor='crosshair';
  else if(m==='erase') canvas.style.cursor=`url('${CUR_ERASER}') 6 18, crosshair`;
  else canvas.style.cursor='move';
}
document.querySelectorAll('.tool[data-tool]').forEach(b=>b.onclick=()=>selectTool(b.dataset.tool));
selectTool('paint');

/* 팝업 (열 때마다 최신 렌더) */
const $=s=>document.querySelector(s);
$('#openText').onclick=()=>$('#textModal').style.display='flex';
$('#closeText').onclick=()=>$('#textModal').style.display='none';
$('#openPattern').onclick=()=>{ renderLibrary(); $('#patternModal').style.display='flex'; };
$('#closePattern').onclick=()=>$('#patternModal').style.display='none';

/* 방문자: 업로드/저장 UI 숨김 */
(function hideVisitorOnlyThings(){
  if (!window.IS_VISITOR) return;
  const saveBtn=document.getElementById('saveUserSet');
  const addBtn=document.getElementById('openPattern'); // 버튼은 유지(패턴 열기용) → 업로드가 아니라 '선택'이므로 보이게
  if (saveBtn) saveBtn.style.display='none';
  // 패턴 모달의 드롭존 요소 자체가 없음(템플릿에서 제거)
})();

/* 글꼴 */
const F=s=>s.split('|'), FS=s=>s.split('|');
const font5x7={A:F("01110|10001|10001|11111|10001|10001|10001"),B:F("11110|10001|11110|10001|10001|10001|11110"),C:F("01110|10001|10000|10000|10000|10001|01110"),D:F("11110|10001|10001|10001|10001|10001|11110"),E:F("11111|10000|11110|10000|10000|10000|11111"),F:F("11111|10000|11110|10000|10000|10000|10000"),G:F("01110|10001|10000|10111|10001|10001|01110"),H:F("10001|10001|10001|11111|10001|10001|10001"),I:F("01110|00100|00100|00100|00100|00100|01110"),J:F("00111|00010|00010|00010|10010|10010|01100"),K:F("10001|10010|10100|11000|10100|10010|10001"),L:F("10000|10000|10000|10000|10000|10000|11111"),M:F("10001|11011|10101|10101|10001|10001|10001"),N:F("10001|11001|10101|10011|10001|10001|10001"),O:F("01110|10001|10001|10001|10001|10001|01110"),P:F("11110|10001|10001|11110|10000|10000|10000"),Q:F("01110|10001|10001|10001|10101|10010|01101"),R:F("11110|10001|10001|11110|10100|10010|10001"),S:F("01111|10000|10000|01110|00001|00001|11110"),T:F("11111|00100|00100|00100|00100|00100|00100"),U:F("10001|10001|10001|10001|10001|10001|01110"),V:F("10001|10001|10001|10001|10001|01010|00100"),W:F("10001|10001|10001|10101|10101|11011|10001"),X:F("10001|01010|00100|00100|00100|01010|10001"),Y:F("10001|01010|00100|00100|00100|00100|00100"),Z:F("11111|00001|00010|00100|01000|10000|11111"),"0":F("01110|10001|10011|10101|11001|10001|01110"),"1":F("00100|01100|00100|00100|00100|00100|01110"),"2":F("01110|10001|00001|00010|00100|01000|11111"),"3":F("11110|00001|00001|01110|00001|00001|11110"),"4":F("00010|00110|01010|10010|11111|00010|00010"),"5":F("11111|10000|11110|00001|00001|10001|01110"),"6":F("01110|10000|11110|10001|10001|10001|01110"),"7":F("11111|00001|00010|00100|01000|01000|01000"),"8":F("01110|10001|10001|01110|10001|10001|01110"),"9":F("01110|10001|10001|01111|00001|00001|01110")," ":F("00000|00000|00000|00000|00000|00000|00000")};
const font4x5=(()=>{const b={A:FS("0110|1001|1111|1001|1001"),B:FS("1110|1001|1110|1001|1110"),C:FS("0111|1000|1000|1000|0111"),D:FS("1110|1001|1001|1001|1110"),E:FS("1111|1000|1110|1000|1111"),F:FS("1111|1000|1110|1000|1000"),G:FS("0111|1000|1011|1001|0111"),H:FS("1001|1001|1111|1001|1001"),I:FS("0110|0010|0010|0010|0110"),J:FS("0001|0001|0001|1001|0110"),K:FS("1001|1010|1100|1010|1001"),L:FS("1000|1000|1000|1000|1111"),M:FS("1001|1111|1111|1001|1001"),N:FS("1001|1101|1011|1001|1001"),O:FS("0110|1001|1001|1001|0110"),P:FS("1110|1001|1110|1000|1000"),Q:FS("0110|1001|1001|0110|0011"),R:FS("1110|1001|1110|1010|1001"),S:FS("0111|1000|0110|0001|1110"),T:FS("1111|0010|0010|0010|0010"),U:FS("1001|1001|1001|1001|0110"),V:FS("1001|1001|1001|0110|0010"),W:FS("1001|1001|1111|1111|1001"),X:FS("1001|0110|0010|0110|1001"),Y:FS("1001|0110|0010|0010|0010"),Z:FS("1111|0001|0010|0100|1111"),"0":FS("0110|1001|1001|1001|0110"),"1":FS("0010|0110|0010|0010|0111"),"2":FS("0110|0001|0010|0100|1111"),"3":FS("1110|0001|0110|0001|1110"),"4":FS("1001|1001|1111|0001|0001"),"5":FS("1111|1000|1110|0001|1110"),"6":FS("0111|1000|1110|1001|0110"),"7":FS("1111|0001|0010|0100|0100"),"8":FS("0110|1001|0110|1001|0110"),"9":FS("0110|1001|0111|0001|1110")," ":FS("0000|0000|0000|0000|0000")};const out={...b};"abcdefghijklmnopqrstuvwxyz".split('').forEach((ch,i)=>{out[ch]=out[String.fromCharCode(65+i)]});return out;})();

/* 텍스트 */
function rebuildTextLayer(){
  for(let y=0;y<size;y++) for(let x=0;x<size;x++) textLayer[y][x]=null;
  const text=$('#centerText').value, kind=$('#fontSizeSel').value;
  const lines=text.split('\n').slice(0,2);
  const font=(kind==='tiny')?font4x5:font5x7;
  const gw=(kind==='tiny')?4:5, gh=(kind==='tiny')?5:7;
  const gap=1, lineGap=2, totalH=lines.length*gh+(lines.length-1)*lineGap;
  let y0=MARGIN+Math.floor((innerSize-totalH)/2);
  lines.forEach((line,li)=>{
    let w=line.length?(line.length*gw+(line.length-1)*gap):0;
    let x0=MARGIN+Math.floor((innerSize-w)/2);
    for(const ch of line){
      const g=font[ch]||font[ch.toUpperCase()]||font[' '];
      for(let r=0;r<gh;r++) for(let c=0;c<gw;c++){
        if(g[r][c]==='1'){
          const yy=y0+li*(gh+lineGap)+r, xx=x0+c;
          if(yy>=innerMin&&yy<=innerMax&&xx>=innerMin&&xx<=innerMax) textLayer[yy][xx]=textColor;
        }
      }
      x0+=gw+gap;
    }
  });
  drawMain();
}
document.getElementById('centerText').addEventListener('input', rebuildTextLayer);
document.getElementById('fontSizeSel').addEventListener('change', rebuildTextLayer);

/* 저장/초기화 */
document.getElementById('savePng').onclick=()=>{ const a=document.createElement('a'); a.download='lego_design_32x32.png'; a.href=canvas.toDataURL(); a.click(); };
document.getElementById('clearBoard').onclick=()=>{ grid=Array.from({length:size},()=>Array(size).fill(bgColor)); textLayer=Array.from({length:size},()=>Array(size).fill(null)); selection=null; selectedCells=[]; tileGhost=null; drawMain(); };

/* 스터드 */
function drawStudFlat(cx,cy,r){ ctx.fillStyle='rgba(0,0,0,0.05)'; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,0.08)'; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(cx,cy,r-0.5,0,Math.PI*2); ctx.stroke(); }

/* 렌더 */
function drawMain(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle='#000'; ctx.font='12px sans-serif'; ctx.textAlign='center'; ctx.textBaseline='middle';
  const marks=[1,5,10,15,20,25,30];
  for(let x=0;x<size;x++){const n=x+1; if(marks.includes(n)) ctx.fillText(n, offset+x*cellSize+cellSize/2, offset/2);}
  for(let y=0;y<size;y++){const n=y+1; if(marks.includes(n)) ctx.fillText(n, offset/2, offset+y*cellSize+cellSize/2);}

  for(let y=0;y<size;y++) for(let x=0;x<size;x++){ ctx.fillStyle=grid[y][x]; ctx.fillRect(offset+x*cellSize, offset+y*cellSize, cellSize, cellSize); }
  for(let y=0;y<size;y++) for(let x=0;x<size;x++){ const col=textLayer[y][x]; if(!col) continue; ctx.fillStyle=col; ctx.fillRect(offset+x*cellSize, offset+y*cellSize, cellSize, cellSize); }

  const r=cellSize*0.28;
  for(let y=0;y<size;y++) for(let x=0;x<size;x++){ const cx=offset+x*cellSize+cellSize/2, cy=offset+y*cellSize+cellSize/2; drawStudFlat(cx,cy,r); }

  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid')||'#d6cfae'; ctx.lineWidth=1;
  for(let i=0;i<=size;i++){ ctx.beginPath(); ctx.moveTo(offset+i*cellSize, offset); ctx.lineTo(offset+i*cellSize, offset+size*cellSize); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(offset, offset+i*cellSize); ctx.lineTo(offset+size*cellSize, offset+i*cellSize); ctx.stroke(); }
  ctx.strokeStyle=getComputedStyle(document.documentElement).getPropertyValue('--grid10')||'#9c9576'; ctx.lineWidth=2;
  for(let i=10;i<size;i+=10){ ctx.beginPath(); ctx.moveTo(offset+i*cellSize, offset); ctx.lineTo(offset+i*cellSize, offset+size*cellSize); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(offset, offset+i*cellSize); ctx.lineTo(offset+size*cellSize, offset+i*cellSize); ctx.stroke(); }

  drawSelectionOverlay(); drawTileGhost();
}

/* 좌표 유틸 */
function getClientXY(e){ if(e.touches&&e.touches[0])return {clientX:e.touches[0].clientX,clientY:e.touches[0].clientY}; if(e.changedTouches&&e.changedTouches[0])return {clientX:e.changedTouches[0].clientX,clientY:e.changedTouches[0].clientY}; return {clientX:e.clientX,clientY:e.clientY}; }
function getCellFromXY(clientX,clientY){ const r=canvas.getBoundingClientRect(); const x=Math.floor((clientX-r.left-offset)/cellSize); const y=Math.floor((clientY-r.top-offset)/cellSize); if(x<innerMin||x>innerMax||y<innerMin||y>innerMax) return null; return {x,y}; }

/* 그리기/지우개 */
function paintStart(e){ const {clientX,clientY}=getClientXY(e); const p=getCellFromXY(clientX,clientY); if(!p) return;
  if(mode==='paint'){grid[p.y][p.x]=brushColor; isPainting=true;} else if(mode==='erase'){grid[p.y][p.x]=bgColor; textLayer[p.y][p.x]=null; isErasing=true;} drawMain(); e.preventDefault?.();}
function paintMove(e){ const {clientX,clientY}=getClientXY(e); const p=getCellFromXY(clientX,clientY); if(!p) return;
  if(mode==='paint'&&isPainting){grid[p.y][p.x]=brushColor; drawMain();} else if(mode==='erase'&&isErasing){grid[p.y][p.x]=bgColor; textLayer[p.y][p.x]=null; drawMain();} e.preventDefault?.();}
function paintEnd(){ isPainting=false; isErasing=false; }
canvas.addEventListener('mousedown', paintStart);
canvas.addEventListener('mousemove', paintMove);
window.addEventListener('mouseup', paintEnd);
canvas.addEventListener('touchstart', paintStart, {passive:false});
canvas.addEventListener('touchmove', paintMove, {passive:false});
window.addEventListener('touchend', paintEnd);

/* 선택/이동 */
let selection=null, selecting=false, dragging=false, dragStart=null, previewDelta={dx:0,dy:0}, selectedCells=[];
function colorAt(x,y){ return textLayer[y][x] || (grid[y][x]!==bgColor?grid[y][x]:null); }
function cellInSel(x,y){ if(!selection) return false; return x>=selection.x&&x<selection.x+selection.w && y>=selection.y&&y<selection.y+selection.h; }
function norm(a,b){ return {x:Math.min(a.x,b.x),y:Math.min(a.y,b.y),w:Math.abs(a.x-b.x)+1,h:Math.abs(a.y-b.y)+1}; }
function buildPicked(){ selectedCells=[]; for(let y=selection.y;y<selection.y+selection.h;y++) for(let x=selection.x;x<selection.x+selection.w;x++){ if(textLayer[y][x]) selectedCells.push({x,y,color:textLayer[y][x],layer:'text'}); else if(grid[y][x]!==bgColor) selectedCells.push({x,y,color:grid[y][x],layer:'grid'});} }
function pickComponent(sx,sy){ const q=[[sx,sy]], seen=new Set([sx+','+sy]), cells=[[sx,sy]], dirs=[[1,0],[-1,0],[0,1],[0,-1],[1,1],[1,-1],[-1,1],[-1,-1]];
  while(q.length){ const [x,y]=q.shift(); for(const[dx,dy] of dirs){ const nx=x+dx, ny=y+dy, k=nx+','+ny; if(nx<innerMin||nx>innerMax||ny<innerMin||ny>innerMax||seen.has(k)) continue; if(colorAt(nx,ny)){ seen.add(k); q.push([nx,ny]); cells.push([nx,ny]); } } }
  let minx=1e9,miny=1e9,maxx=-1e9,maxy=-1e9; cells.forEach(([x,y])=>{minx=Math.min(minx,x);miny=Math.min(miny,y);maxx=Math.max(maxx,x);maxy=Math.max(maxy,y);});
  return {x:minx,y:miny,w:maxx-minx+1,h:maxy-miny+1}; }
function drawSelectionOverlay(){ if(!selection) return; ctx.strokeStyle='#0b7'; ctx.lineWidth=2;
  ctx.strokeRect(offset+selection.x*cellSize, offset+selection.y*cellSize, selection.w*cellSize, selection.h*cellSize);
  if(dragging&&(previewDelta.dx||previewDelta.dy)){ ctx.globalAlpha=0.6; for(const c of selectedCells){ const nx=c.x+previewDelta.dx, ny=c.y+previewDelta.dy; ctx.fillStyle=c.color; ctx.fillRect(offset+nx*cellSize, offset+ny*cellSize, cellSize, cellSize);} ctx.globalAlpha=1; } }
function selStart(e){ if(mode!=='select') return; const {clientX,clientY}=getClientXY(e); const p=getCellFromXY(clientX,clientY); if(!p) return;
  if(selection&&cellInSel(p.x,p.y)){ dragging=true; selecting=false; dragStart=p; previewDelta={dx:0,dy:0}; }
  else{ if(colorAt(p.x,p.y)){ selection=pickComponent(p.x,p.y); buildPicked(); drawMain(); dragging=true; dragStart=p; } else{ selecting=true; dragging=false; selection={x:p.x,y:p.y,w:1,h:1}; drawMain(); } } e.preventDefault?.(); }
function selMove(e){ if(mode!=='select') return; const {clientX,clientY}=getClientXY(e); const p=getCellFromXY(clientX,clientY); if(!p) return;
  if(selecting&&selection){ Object.assign(selection, norm({x:selection.x,y:selection.y}, p)); drawMain(); }
  else if(dragging&&selection){ let dx=p.x-dragStart.x, dy=p.y-dragStart.y;
    dx=Math.max(innerMin-selection.x, Math.min(innerMax-(selection.x+selection.w-1), dx));
    dy=Math.max(innerMin-selection.y, Math.min(innerMax-(selection.y+selection.h-1), dy));
    previewDelta={dx,dy}; drawMain(); } e.preventDefault?.(); }
function selEnd(){ if(mode!=='select') return;
  if(selecting){ selecting=false; buildPicked(); drawMain(); }
  else if(dragging){ dragging=false; if(previewDelta.dx||previewDelta.dy){
      for(const c of selectedCells){ if(c.layer==='text') textLayer[c.y][c.x]=null; else grid[c.y][c.x]=bgColor; }
      const moved=[]; for(const c of selectedCells){ const nx=c.x+previewDelta.dx, ny=c.y+previewDelta.dy; if(c.layer==='text') textLayer[ny][nx]=c.color; else grid[ny][nx]=c.color; moved.push({x:nx,y:ny,color:c.color,layer:c.layer}); }
      selection.x+=previewDelta.dx; selection.y+=previewDelta.dy; selectedCells=moved; previewDelta={dx:0,dy:0}; drawMain(); } } }
canvas.addEventListener('mousedown', selStart); canvas.addEventListener('mousemove', selMove); window.addEventListener('mouseup', selEnd);
canvas.addEventListener('touchstart', selStart, {passive:false}); canvas.addEventListener('touchmove', selMove, {passive:false}); window.addEventListener('touchend', selEnd);

/* 패턴 라이브러리(업로드/저장 없이 사용만) */
const P={WHT:'#ffffff',RED:'#cc0a00',BLU:'#0039d1',YEL:'#febc06',LIM:'#fff87c',BLK:'#000000',PUR:'#6d4b97',LBL:'#75b8ff'};
const patterns={ flower:[[null,P.RED,null],[P.RED,P.YEL,P.RED],[null,P.RED,null]], dot:[[null,null,null],[null,P.BLU,null],[null,null,null]], stem:[[null,P.PUR,null],[null,P.PUR,null],[null,P.PUR,null]], heart:[[P.RED,null,P.RED],[P.RED,P.RED,P.RED],[null,P.RED,null]], diag:[[P.BLK,null,null],[null,P.BLK,null],[null,null,P.BLK]], rdiag:[[null,null,P.BLK],[null,P.BLK,null],[P.BLK,null,null]], tri:[[null,P.LBL,null],[P.LBL,P.LBL,P.LBL],[null,null,null]] };
function sparkleTile(){ const c=[P.WHT,P.LIM,P.LBL,P.YEL][Math.floor(Math.random()*4)]; return [[null,c,null],[c,c,c],[null,c,null]]; }
const libGrid=document.getElementById('libGrid'); const libCell=16;
let library=[ {name:'flower',tile:patterns.flower},{name:'dot',tile:patterns.dot},{name:'stem',tile:patterns.stem},{name:'heart',tile:patterns.heart},{name:'diag',tile:patterns.diag},{name:'rdiag',tile:patterns.rdiag},{name:'tri',tile:patterns.tri},{name:'sparkle',tile:sparkleTile()} ];
function recolorTile(src,c1,c2){ const h=src.length,w=src[0].length,f=new Map(); for(let r=0;r<h;r++) for(let c=0;c<w;c++){ const col=src[r][c]; if(col) f.set(col,(f.get(col)||0)+1); }
  const out=src.map(r=>r.slice()); const arr=[...f.entries()].sort((a,b)=>b[1]-a[1]); if(!arr.length) return out;
  if(arr.length===1){ const a=arr[0][0]; for(let r=0;r<h;r++) for(let c=0;c<w;c++) if(out[r][c]===a) out[r][c]=c1; }
  else{ const major=arr[0][0], minor=arr[1][0]; for(let r=0;r<h;r++) for(let c=0;c<w;c++){ const col=out[r][c]; if(!col) continue; out[r][c]=(col===major)?c1:(col===minor)?c2:c1; } }
  return out; }
function drawTilePreview(tile,cvs){ const h=tile.length,w=tile[0].length; cvs.width=w*libCell; cvs.height=h*libCell; const g=cvs.getContext('2d'); g.clearRect(0,0,cvs.width,cvs.height);
  for(let r=0;r<h;r++) for(let c=0;c<w;c++){ const col=tile[r][c]; g.fillStyle=col||'#eee'; g.fillRect(c*libCell,r*libCell,libCell,libCell); g.strokeStyle='#ddd'; g.strokeRect(c*libCell,r*libCell,libCell,libCell); } }
function renderLibrary(){ libGrid.innerHTML=''; library.forEach(item=>{ const base=item.name==='sparkle'?sparkleTile():item.tile; const recol=recolorTile(base, patternColor1, patternColor2);
  const wrap=document.createElement('div'); wrap.className='tileCard'; const c=document.createElement('canvas'); drawTilePreview(recol,c);
  c.title=item.name; c.onmousedown=()=>{ const b=item.name==='sparkle'?sparkleTile():item.tile; const forDrop=recolorTile(b, patternColor1, patternColor2); tileGhost={tile:JSON.parse(JSON.stringify(forDrop)),gx:innerMin,gy:innerMin}; document.getElementById('patternModal').style.display='none'; };
  wrap.appendChild(c); libGrid.appendChild(wrap); }); }

/* 방문자: 사용자 저장 패턴 로드 차단(기본 패턴만) */
(function bootLibrary(){ renderLibrary(); })();

/* 타일 드래그 고스트 */
let tileGhost=null;
function drawTileGhost(){ if(!tileGhost) return; const t=tileGhost.tile, gy=tileGhost.gy, gx=tileGhost.gx;
  ctx.globalAlpha=0.7; for(let r=0;r<t.length;r++) for(let c=0;c<t[0].length;c++){ const col=t[r][c]; if(!col) continue; const x=gx+c, y=gy+r;
    if(x>=innerMin&&x<=innerMax&&y>=innerMin&&y<=innerMax) ctx.fillStyle=col, ctx.fillRect(offset+x*cellSize, offset+y*cellSize, cellSize, cellSize); }
  ctx.globalAlpha=1; }
function ghostMove(e){ if(!tileGhost) return; const {clientX,clientY}=getClientXY(e); const r=canvas.getBoundingClientRect();
  const x=Math.floor((clientX-r.left-offset)/cellSize), y=Math.floor((clientY-r.top-offset)/cellSize); if(isNaN(x)||isNaN(y)) return;
  const gx=Math.max(innerMin, Math.min(innerMax-(tileGhost.tile[0].length-1), x)); const gy=Math.max(innerMin, Math.min(innerMax-(tileGhost.tile.length-1), y));
  tileGhost.gx=gx; tileGhost.gy=gy; drawMain(); e.preventDefault?.(); }
function ghostDrop(e){ if(!tileGhost) return; const {clientX,clientY}=getClientXY(e); const r=canvas.getBoundingClientRect();
  if(clientX>=r.left+offset && clientX<=r.left+offset+size*cellSize && clientY>=r.top+offset && clientY<=r.top+offset+size*cellSize){
    const t=tileGhost.tile, gx=tileGhost.gx, gy=tileGhost.gy; for(let rr=0;rr<t.length;rr++) for(let cc=0;cc<t[0].length;cc++){ const col=t[rr][cc]; if(!col) continue;
      const x=gx+cc, y=gy+rr; if(x>=innerMin&&x<=innerMax&&y>=innerMin&&y<=innerMax) grid[y][x]=col; } }
  tileGhost=null; drawMain(); }
window.addEventListener('mousemove', ghostMove); window.addEventListener('mouseup', ghostDrop);
window.addEventListener('touchmove', ghostMove, {passive:false}); window.addEventListener('touchend', ghostDrop);

/* 시작 */
function drawStudFlat(cx,cy,r){ ctx.fillStyle='rgba(0,0,0,0.05)'; ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2); ctx.fill(); ctx.strokeStyle='rgba(0,0,0,0.08)'; ctx.lineWidth=1; ctx.beginPath(); ctx.arc(cx,cy,r-0.5,0,Math.PI*2); ctx.stroke(); }
rebuildTextLayer(); drawMain();
</script>
</body>
</html>
